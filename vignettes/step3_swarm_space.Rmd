---
title: "3 - Create the swarm space"
author: "Marina Papadopoulou"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{3 - Create the swarm space}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## 3.1 Load data

Load the metrics of collective motion calculated previously. Include the events you want to compare in a swarm space.

```{r message=FALSE, warning=FALSE}
library(swaRmverse)
data("multi_species_metrics")

## Create the swarm space for this data only:
all_data <- multi_species_metrics

## Or bind with new data if continuing from step2
data_df <- get(data("tracks", package = "trackdf"))
data_df$set <- as.Date(data_df$t)

new_species_metrics <- col_motion_metrics_from_raw(data_df,
                                mov_av_time_window = 10,
                                step2time = 1,
                                geo = TRUE,
                                verbose = FALSE,
                                speed_lim = 0,
                                pol_lim = 0.3,
                                parallelize_all = FALSE
                                )

new_species_metrics$species <- "new_species"

## Bind datasets for pca:
new_species <- new_species_metrics[,!colnames(new_species_metrics) %in% c('event_dur', 'N', 'set', 'start_time')] # remove columns not needed for the swarm space
all_data <- rbind(multi_species_metrics, new_species)

```

## 3.2 Build swarm space

Create new swarm space with PCA analysis:

```{r}
new_pca <- create_swarm_space(metrics_data = all_data,
                              space_type = "pca"
                              )

ggplot2::ggplot(new_pca$swarm_space,
                 ggplot2::aes(x = PC1, y = PC2, color = species)
                ) +
                ggplot2::geom_point() +
                ggplot2::theme_bw()

```

Check what each principal component represents and get the info of each event:

```{r}
pcs_info <- new_pca$pca$rotation[, new_pca$pca$sdev > 1]
print(pcs_info)

ref_data <- new_pca$ref
```

Or create a new swarm space with tSNE to better study the local structure of the data:

```{r}

new_tsne <- create_swarm_space(metrics_data = all_data,
                              space_type = "tsne",
                              tsne_rand_seed = 2023,
                              tsne_perplexity = 10
                              )

print("t-SNE was run with the following parameters:")
print(new_tsne$tsne_setup)

ggplot2::ggplot(new_tsne$swarm_space, ggplot2::aes(x = X, y = Y, color = species)) +
  ggplot2::geom_point() +
  ggplot2::theme_bw()

```

## 3.3 Expand existing swarm space

Starting from previously generated PCA swarm space, add new data:

```{r}
data("multi_species_pca.rda")
data("multi_species_pca_data.rda")

new_pca_data <- expand_pca_swarm_space(metrics_data = new_species_metrics,
                                       pca_space = multi_species_pca)

expanded_pca <- rbind(multi_species_pca_data, 
                      new_pca_data)

ggplot2::ggplot(expanded_pca,
                ggplot2::aes(x = PC1, y = PC2, color = species)) +
   ggplot2::geom_point() +
   ggplot2::theme_bw()

```
